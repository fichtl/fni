type: "Lightweight Attack Detection Graph"

# abnormal nic pcap file path
input_stream: "GIn_pcapPath:0:pcapPath"


# graph2 output 
output_stream: "GOut_attack_res:0:attack_res"

node {
    name: "abnormal_nic_pcap_parser"
    task: "PcapParseTask"
    input_stream: "GIn_pcapPath:0:pcapPath"
    output_stream: "GOut_parsed_packets:0:parsed_packets"
}

node {
    name: "abnormal_pcap_feature_counter"
    task: "FeatureCounterTask"
    input_stream: "GOut_parsed_packets:0:parsed_packets"
    output_stream: "NOut_SIP_COUNT:0:sip_count"
    output_stream: "NOut_SPort_COUNT:0:sport_count"
    output_stream: "NOut_DPort_COUNT:0:dport_count"
    output_stream: "NOut_Protocol_COUNT:0:protocol_count"
    output_stream: "NOut_Length_COUNT:0:length_count"
    options {
        [type.asnapis.io/dni.FeatureCounterTaskOptions] {
            feature: "SIP"
            feature: "SPort"
            feature: "DPort"
            feature: "Protocol"
            feature: "Length"
        }
    }

    
}

node {
    name: "sip_attack_score_calc"
    task: "SndNumberStatsTask"
    input_stream: "NOut_SIP_COUNT:0:sip_count"
    output_stream: "NOut_SIP_COUNT_Score:0:sip_count_score"
    options {
        [type.asnapis.io/dni.SndNumberStatsTaskOptions] {
            numValueSum: 10000
            ratioMin: 0.1
            ratioMax: 0.5
            score_thresholds: 0.6
            score_thresholds: 1.0
            score_thresholds: 0.8
            score_thresholds: 0
        }
    }    
}

node {
    name: "sport_attack_score_calc"
    task: "SndNumberStatsTask"
    input_stream: "NOut_SPort_COUNT:0:sport_count"
    output_stream: "NOut_SPort_COUNT_Score:0:sport_count_score"
    options {
        [type.asnapis.io/dni.SndNumberStatsTaskOptions] {
            numValueSum: 10000
            ratioMin: 0.1
            ratioMax: 0.6
            score_thresholds: 0.4
            score_thresholds: 1.0
            score_thresholds: 0.6
            score_thresholds: 0
        }
    }
}

node {
    name: "dport_attack_score_calc"
    task: "SndNumberStatsTask"
    input_stream: "NOut_DPort_COUNT:0:dport_count"
    output_stream: "NOut_DPort_COUNT_Score:0:dport_count_score"
    options {
        [type.asnapis.io/dni.SndNumberStatsTaskOptions] {
            numValueSum: 10000
            ratioMin: 0.1
            ratioMax: 0.6
            score_thresholds: 0.4
            score_thresholds: 1.0
            score_thresholds: 0.6
            score_thresholds: 0
        }
    }
}

node {
    name: "length_attack_score_calc"
    task: "SndNumberStatsTask"
    input_stream: "NOut_Length_COUNT:0:length_count"
    output_stream: "NOut_Length_COUNT_Score:0:length_count_score"
    options {
        [type.asnapis.io/dni.SndNumberStatsTaskOptions] {
            numValueSum: 10000
            ratioMin: 0.1
            ratioMax: 0.6
            score_thresholds: 0.4
            score_thresholds: 1.0
            score_thresholds: 0.6
            score_thresholds: 0
        }
    }
}

node {
    name: "protocol_attack_score_calc"
    task: "SndProtocolStatsTask"
    input_stream: "NOut_Protocol_COUNT:0:protocol_count"
    output_stream: "NOut_Protocol_COUNT_Score:0:protocol_count_score"
    options {
        [type.asnapis.io/dni.SndProtocolStatsTaskOptions] {
            protoCountSum: 10000
            ratioMin: 0.1
            ratioMax: 0.6
            score_thresholds: 0.8
            score_thresholds: 0.6
            score_thresholds: 0
        }
    }
}

node {
    name: "max_number_attack_score_calc"
    task: "MaxTask"
    input_stream: "NOut_SPort_COUNT_Score:0:sport_count_score"
    input_stream: "NOut_DPort_COUNT_Score:0:dport_count_score"
    input_stream: "NOut_Length_COUNT_Score:0:length_count_score"
    output_stream: "NOut_Number_COUNT_Score:0:number_count_score"
}

node{
    name: "attack_total_score"
    task: "SumTask"
    input_stream: "NOut_SIP_COUNT_Score:0:sip_count_score"
    input_stream: "NOut_Number_COUNT_Score:0:number_count_score"
    input_stream: "NOut_Protocol_COUNT_Score:0:protocol_count_score"
    output_stream: "NOut_Attack_Scores_Sum:0:attack_scores_sum"
}

node{
    name: "attack_detection_judge"
    task: "ThresholdTask"
    input_stream:  "NOut_Attack_Scores_Sum:0:attack_scores_sum"
    output_stream: "GOut_attack_res:0:attack_res"
    options {
        [type.asnapis.io/dni.ThresholdTaskOptions] {
            thresh_scores { threshold: 0.22 score: 1}
            thresh_scores { threshold: 0.57 score: 2}
        }
    }
}

